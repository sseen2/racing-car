<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ìë™ì°¨ ê²½ì£¼</title>
</head>

<style>
    body {
        margin: 0;
        padding: 0;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        background-color: #fafafa;
    }

    button {
        padding: 8px 14px;
        border-radius: 4px;
        border: none;
        background-color: #e53935;
        color: #fff;
        font-size: 14px;
        cursor: pointer;
    }

    .page-wrapper {
        padding: 40px 60px;
    }

    .page-title {
        font-size: 32px;
        font-weight: 700;
        margin-bottom: 32px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 32px;
    }

    .layout-main {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 40px;
        min-height: 260px;
    }

    .track-area {
        flex: 1;
    }

    .track-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .track-item {
        font-size: 16px;
        margin-bottom: 8px;
    }

    .track-item .car-name {
        display: inline-block;
        width: 80px;
    }

    .track-item .car-position {
        margin-left: 4px;
    }

    .sidebar {
        width: 220px;
    }

    .sidebar-box {
        border: 1px solid #ccc;
        border-radius: 4px;
        min-height: 220px;
        padding: 16px;
        background-color: #fff;
    }

    .participant-list {
        list-style: none;
        padding: 0;
        margin: 0;
        font-size: 14px;
    }

    .log-section {
        margin-top: 40px;
    }

    .log-box {
        border: 1px solid #ccc;
        border-radius: 4px;
        background-color: #fff;
        min-height: 220px;
        padding: 16px;
        overflow-y: auto;
    }

    .input-row {
        margin-top: 12px;
        gap: 8px;
    }

    .input-row input[type="text"] {
        flex: 1;
        padding: 8px 10px;
        border-radius: 4px;
        border: 1px solid #ccc;
        font-size: 14px;
    }

    .input-row button:hover {
        background-color: #c62828;
    }

    .title {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 10px;
    }
</style>

<body>
    <div class="page-wrapper">
        <div class="header">
            <div class="page-title">ğŸš— ìë™ì°¨ ê²½ì£¼</div>
            <button type="button" onclick="exitRoom()">ë‚˜ê°€ê¸°</button>
        </div>
        <div class="layout-main">
            <div class="track-area" id="car-area">
                <div class="title">ğŸ ì œì¼ ë§ì´ ê°„ ìë™ì°¨ê°€ ìš°ìŠ¹! ğŸ¥‡ğŸ†</div>
                <ul class="track-list" id="car-track-list">
                </ul>
            </div>
            <div class="sidebar">
                <div class="title">í˜„ì¬ ì¸ì›</div>
                <div class="sidebar-box">
                    <ul class="participant-list" id="participant-list">
                </ul>
                </div>
            </div>
        </div>
        <div class="log-section">
            <div class="log-box" id="log-message">
            </div>
            <form onsubmit="startRace(event)">
                <div id="host-only" class="input-row">
                    <input type="text" id="try-count" placeholder="ì‹œë„ íšŸìˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”." autocomplete="off" />
                    <button type="submit" id="start-button">ê²Œì„ ì‹œì‘</button>
                </div>
                <p id="errorMessage" style="color: red; margin-top: 8px;"></p>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

    <script>
        let carInfo = null;
        let stompClient = null;

        function connectWebSocket() {
            const socket = new SockJS('/car-ws');
            stompClient = Stomp.over(socket);

            stompClient.connect({}, function () {
                stompClient.subscribe('/sub/race/log', function (event) {
                    const data = event.body;
                    showLogMessage(data);
                });

                stompClient.subscribe('/sub/race/result', function (event) {
                    const data = JSON.parse(event.body);
                    showResult(data);
                })

                stompClient.subscribe('/sub/race/participants', function (event) {
                    const data = JSON.parse(event.body);
                    showParticipantList(data);
                });
            }, function (error) {
                console.error('âŒ ì—ëŸ¬ ë°œìƒ: ', error);
            });
        }

        function disconnectWebSocket() {
            if (stompClient && stompClient.connected) {
                stompClient.disconnect(() => {
                    console.log('ğŸ”Œ ì›¹ì†Œì¼“ ì—°ê²° í•´ì œ');
                });
            }
        }

        function showLogMessage(data) {
            const logMessage = document.getElementById('log-message');
            if (!logMessage) {
                return;
            }

            const p = document.createElement('p');
            console.log(data);
            p.textContent = data;

            logMessage.appendChild(p);
            logMessage.scrollTop = logMessage.scrollHeight;
        }

        function showResult(data) {
            const trackList = document.getElementById('car-track-list');
            if (!trackList) {
                return;
            }

            trackList.innerHTML = '';

            data.forEach((item) => {
                const li = document.createElement('li');
                li.className = 'track-item';

                const nameSpan = document.createElement('span');
                nameSpan.className = 'car-name';
                nameSpan.textContent = item.carName;

                const positionSpan = document.createElement('span');
                positionSpan.className = 'car-position';
                positionSpan.textContent = 'ğŸš—'.repeat(item.carPosition);

                li.appendChild(nameSpan);
                li.appendChild(positionSpan);
                trackList.appendChild(li);
            });
        }

        function showParticipantList(data) {
            const participantList = document.getElementById('participant-list');
            if (!participantList) {
                return;
            }

            console.log(data);

            participantList.innerHTML = '';

            data.forEach(item => {
                const p = document.createElement('p');
                if (item.isHost) {
                    p.textContent = 'ğŸ‘‘ ' + item.name;
                }
                else {
                    p.textContent = 'ğŸš— ' + item.name;
                }
                participantList.appendChild(p);
            });
        }

        async function startRace(event) {
            event.preventDefault();

            const tryCount = document.getElementById('try-count').value.trim();
            const errorEl = document.getElementById('errorMessage');

            errorEl.textContent = '';

            try {
                const response = await fetch('/api/race/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        carName: carInfo.name,
                        tryCount: tryCount
                    })
                });

                const result = await response.json();

                if (!result.success) {
                    let message = 'ìš”ì²­ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';

                    if (Array.isArray(result.data) && result.data.length > 0 && result.data[0].message) {
                        message = result.data[0].message;
                    } else if (result.message) {
                        message = result.message;
                    }

                    errorEl.textContent = message;
                }
            } catch (error) {
                console.error(error);
            }
        }

        async function loadInitParticipants() {
            try {
                const response = await fetch('/api/car/participants');
                const result = await response.json();

                if (!result.success) {
                    console.error(result.message);
                    return;
                }

                showParticipantList(result.data);
            } catch (error) {
                console.error(error);
            }
        }

        function exitRoom() {
            disconnectWebSocket();

            sessionStorage.removeItem('carInfo');

            window.location.href = '/';
        }


        window.addEventListener('load', function () {
            connectWebSocket();

            const carInfoJson = sessionStorage.getItem('carInfo');
            if (!carInfoJson) {
                alert('ìë™ì°¨ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì…ì¥í•´ì£¼ì„¸ìš”.');
                window.location.href = '/';
                return;
            }

            carInfo = JSON.parse(carInfoJson);

            const hostSection = document.getElementById('host-only');
            if (hostSection && !carInfo.isHost) {
                hostSection.style.display = 'none';
            }

            showLogMessage(`${carInfo.name}ë‹˜ì´ ì…ì¥í–ˆìŠµë‹ˆë‹¤.`);

            loadInitParticipants();
        });
    </script>
</body>
</html>
